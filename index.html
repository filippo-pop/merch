<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ristampa & vendite – dashboard mobile</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #05060a;
      --bg-card: #13151c;
      --fg: #f7f7f7;
      --accent: #ffb347;
      --muted: #9ea2b0;
      --border: #262938;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #171a25 0, #05060a 55%);
      color: var(--fg);
      padding: 16px;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 6px;
    }
    p.desc {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
      font-size: 0.75rem;
      margin-bottom: 12px;
    }
    .pill span.num {
      font-weight: 600;
      color: var(--accent);
    }
    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .control-group {
      flex: 1 1 120px;
      min-width: 0;
    }
    label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 2px;
      display: block;
    }
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(9,10,16,0.9);
      color: var(--fg);
      font-size: 0.82rem;
      appearance: none;
    }
    .view-toggle {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    .view-toggle button {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(10,11,18,0.9);
      color: var(--muted);
      font-size: 0.8rem;
    }
    .view-toggle button.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(255,179,71,0.08);
    }
    #chart {
      width: 100%;
      height: 260px;
      max-width: 100%;
      margin-bottom: 10px;
    }
    .cards {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }
    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      box-shadow: 0 6px 20px rgba(0,0,0,0.45);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }
    .tipo {
      font-size: 0.95rem;
      font-weight: 600;
    }
    .categoria {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .colore {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .badge-taglia {
      font-size: 0.72rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      color: var(--accent);
    }
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
    }
    .row-label {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .row-values {
      font-size: 0.82rem;
      font-variant-numeric: tabular-nums;
    }
    .row-values strong {
      color: var(--accent);
    }
    #cardsView { display: block; }
    #recapView { display: none; margin-top: 8px; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 4px 5px;
    }
    th {
      background: rgba(255,255,255,0.03);
      font-weight: 500;
      text-align: left;
    }
    @media (min-width: 768px) {
      body { padding: 24px; }
      #chart { height: 320px; }
      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
      }
    }
  </style>
</head>
<body>
  <h1>Ristampa & vendite</h1>
  <p class="desc">
    Dashboard per decidere le <strong>ristampe</strong> a partire dai <strong>venduti</strong>.
    Il grafico mostra le quantità vendute, mentre carte e recap combinano venduto e ristampa
    per diversi scenari (% sul venduto) e con/senza dettaglio colore. Le ristampe per ogni
    TIPO×COLORE sono arrotondate a multipli di 5 e poi ripartite sulle taglie secondo la
    distribuzione delle vendite.
  </p>
  <div class="pill">
    <span>Target complessivo (scenario attuale):</span>
    <span class="num" id="totTarget"></span>
  </div>

  <div class="controls">
    <div class="control-group">
      <label for="scenarioSelect">% ristampa su venduto</label>
      <select id="scenarioSelect">
        <option value="0.25">25%</option>
        <option value="0.5" selected>50%</option>
        <option value="0.75">75%</option>
        <option value="1">100%</option>
      </select>
    </div>
    <div class="control-group">
      <label for="categoriaFilter">Categoria</label>
      <select id="categoriaFilter">
        <option value="ALL">Tutte</option>
      </select>
    </div>
    <div class="control-group">
      <label for="tipoFilter">TIPO</label>
      <select id="tipoFilter">
        <option value="ALL">Tutti</option>
      </select>
    </div>
    <div class="control-group">
      <label for="tagliaFilter">Taglia (per carte/recap)</label>
      <select id="tagliaFilter">
        <option value="ALL">Tutte</option>
        <option value="S">S</option>
        <option value="M">M</option>
        <option value="L">L</option>
        <option value="XL">XL</option>
      </select>
    </div>
    <div class="control-group">
      <label for="modeSelect">Dettaglio colore</label>
      <select id="modeSelect">
        <option value="color">Con colori</option>
        <option value="tipo">Aggregato (senza colori)</option>
      </select>
    </div>
    <div class="control-group">
      <label for="topNSelect">Top per grafico/recap</label>
      <select id="topNSelect">
        <option value="20" selected>Top 20</option>
        <option value="50">Top 50</option>
        <option value="ALL">Tutti</option>
      </select>
    </div>
  </div>

  <div class="view-toggle">
    <button id="btnCards" class="active" data-view="cards">Vista carte</button>
    <button id="btnRecap" data-view="recap">Vista recap</button>
  </div>

  <div id="chart"></div>

  <div id="cardsView">
    <div id="cards" class="cards"></div>
  </div>

  <div id="recapView">
    <table>
      <thead>
        <tr>
          <th>Categoria</th>
          <th>TIPO</th>
          <th>Colore</th>
          <th>Venduti totali</th>
          <th>Ristampa suggerita</th>
        </tr>
      </thead>
      <tbody id="recapBody"></tbody>
    </table>
  </div>

  <script>
    let dataByColor = [];
    let dataByTipo = [];
    let totalSold = 0;

    const scenarioSelect = document.getElementById('scenarioSelect');
    const categoriaFilter = document.getElementById('categoriaFilter');
    const tipoFilter = document.getElementById('tipoFilter');
    const tagliaFilter = document.getElementById('tagliaFilter');
    const modeSelect = document.getElementById('modeSelect');
    const topNSelect = document.getElementById('topNSelect');
    const totTargetSpan = document.getElementById('totTarget');
    const cardsEl = document.getElementById('cards');
    const recapBody = document.getElementById('recapBody');
    const btnCards = document.getElementById('btnCards');
    const btnRecap = document.getElementById('btnRecap');
    const cardsView = document.getElementById('cardsView');
    const recapView = document.getElementById('recapView');

    async function loadData() {
      const res = await fetch('data-merch.csv?cacheBust=' + Date.now());
      const text = await res.text();
      const lines = text.trim().split('\n');
      const header = lines[0].split(',').map(h => h.trim());
      const rows = lines.slice(1).filter(l => l.trim().length > 0);

      const raw = rows.map(line => {
        const cols = line.split(',').map(c => c.trim());
        const obj = {};
        header.forEach((h, i) => { obj[h] = cols[i] ?? ''; });
        obj.TOT_S = parseInt(obj.TOT_S || '0', 10);
        obj.TOT_M = parseInt(obj.TOT_M || '0', 10);
        obj.TOT_L = parseInt(obj.TOT_L || '0', 10);
        obj.TOT_XL = parseInt(obj.TOT_XL || '0', 10);
        return obj;
      });

      dataByColor = [];
      totalSold = 0;

      const sizes = ['S', 'M', 'L', 'XL'];

      for (const r of raw) {
        const counts = {
          S: r.TOT_S,
          M: r.TOT_M,
          L: r.TOT_L,
          XL: r.TOT_XL
        };
        totalSold += counts.S + counts.M + counts.L + counts.XL;

        for (const size of sizes) {
          const venduti = counts[size];
          if (venduti > 0) {
            dataByColor.push({
              Categoria: r.Categoria,
              TIPO: r.TIPO,
              COLORE: r.COLORE,
              Taglia: size,
              venduti: venduti
            });
          }
        }
      }

      // Aggregato per TIPO (senza colori)
      const mapTipo = new Map();
      for (const d of dataByColor) {
        const key = d.Categoria + '||' + d.TIPO + '||' + d.Taglia;
        if (!mapTipo.has(key)) {
          mapTipo.set(key, {
            Categoria: d.Categoria,
            TIPO: d.TIPO,
            COLORE: 'Tutte le colorazioni',
            Taglia: d.Taglia,
            venduti: 0
          });
        }
        mapTipo.get(key).venduti += d.venduti;
      }
      dataByTipo = Array.from(mapTipo.values());

      // Popola filtro Categoria
      const categorie = Array.from(new Set(dataByColor.map(d => d.Categoria))).sort();
      for (const c of categorie) {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        categoriaFilter.appendChild(opt);
      }

      attachEvents();
      renderAll();
    }

    function getCurrentDataBase() {
      const mode = modeSelect.value;
      return mode === 'color' ? dataByColor : dataByTipo;
    }

    function currentFactor() {
      return parseFloat(scenarioSelect.value);
    }

    function refreshTipoOptions() {
      const catSel = categoriaFilter.value;
      const base = getCurrentDataBase();
      const tipiSet = new Set();
      for (const d of base) {
        if (catSel === 'ALL' || d.Categoria === catSel) {
          tipiSet.add(d.TIPO);
        }
      }
      const tipi = Array.from(tipiSet).sort();
      const current = tipoFilter.value;
      tipoFilter.innerHTML = '<option value="ALL">Tutti</option>';
      for (const t of tipi) {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        tipoFilter.appendChild(opt);
      }
      if (tipi.includes(current)) {
        tipoFilter.value = current;
      }
    }

    function computeAllocations() {
      const factor = currentFactor();
      const mode = modeSelect.value;
      const catSel = categoriaFilter.value;
      const tipoSel = tipoFilter.value;
      const base = getCurrentDataBase();

      const groupMap = new Map();

      for (const d of base) {
        if (catSel !== 'ALL' && d.Categoria !== catSel) continue;
        if (tipoSel !== 'ALL' && d.TIPO !== tipoSel) continue;
        const coloreKey = mode === 'color' ? d.COLORE : 'Tutte le colorazioni';
        const key = d.Categoria + '||' + d.TIPO + '||' + coloreKey;
        if (!groupMap.has(key)) {
          groupMap.set(key, {
            Categoria: d.Categoria,
            TIPO: d.TIPO,
            COLORE: coloreKey,
            items: []
          });
        }
        groupMap.get(key).items.push(d);
      }

      const allocations = [];
      let totalTarget = 0;

      for (const [key, group] of groupMap.entries()) {
        const items = group.items;
        let totalVenduti = 0;
        for (const it of items) {
          totalVenduti += it.venduti;
        }

        const rawGroup = totalVenduti * factor;
        let groupTarget = Math.round(rawGroup / 5) * 5;
        if (groupTarget < 0) groupTarget = 0;

        if (groupTarget === 0 || totalVenduti === 0) {
          for (const it of items) {
            allocations.push({
              Categoria: group.Categoria,
              TIPO: group.TIPO,
              COLORE: group.COLORE,
              Taglia: it.Taglia,
              venduti: it.venduti,
              ristampa: 0
            });
          }
          continue;
        }

        const raws = items.map(it => groupTarget * it.venduti / totalVenduti);
        const floors = raws.map(x => Math.floor(x));
        let sumFloors = floors.reduce((a, b) => a + b, 0);
        let remainder = groupTarget - sumFloors;

        const fracs = raws.map((x, i) => ({ idx: i, frac: x - floors[i] }));
        fracs.sort((a, b) => b.frac - a.frac);

        let k = 0;
        while (remainder > 0 && k < fracs.length) {
          floors[fracs[k].idx] += 1;
          remainder -= 1;
          k += 1;
        }

        for (let i = 0; i < items.length; i++) {
          const it = items[i];
          const r = floors[i];
          allocations.push({
            Categoria: group.Categoria,
            TIPO: group.TIPO,
            COLORE: group.COLORE,
            Taglia: it.Taglia,
            venduti: it.venduti,
            ristampa: r
          });
        }

        totalTarget += groupTarget;
      }

      return { allocations, totalTarget };
    }

    function getAllocationsFiltered() {
      const { allocations, totalTarget } = computeAllocations();
      const tagliaSel = tagliaFilter.value;
      if (tagliaSel === 'ALL') {
        return { allocations, totalTarget };
      }
      const filtered = allocations.filter(d => d.Taglia === tagliaSel);
      return { allocations: filtered, totalTarget };
    }

    function updateTargetTotal(totalTarget) {
      totTargetSpan.textContent = totalTarget;
    }

    function renderCards(allocations) {
      const arr = allocations.slice().sort((a, b) => b.ristampa - a.ristampa);
      cardsEl.innerHTML = '';

      if (arr.length === 0) {
        const msg = document.createElement('p');
        msg.className = 'desc';
        msg.textContent = 'Nessun elemento con i filtri selezionati.';
        cardsEl.appendChild(msg);
        return;
      }

      const mode = modeSelect.value;

      for (const d of arr) {
        const card = document.createElement('div');
        card.className = 'card';

        const header = document.createElement('div');
        header.className = 'card-header';

        const left = document.createElement('div');
        const catSpan = document.createElement('div');
        catSpan.className = 'categoria';
        catSpan.textContent = d.Categoria;

        const tipoSpan = document.createElement('div');
        tipoSpan.className = 'tipo';
        tipoSpan.textContent = d.TIPO;

        const coloreSpan = document.createElement('div');
        coloreSpan.className = 'colore';
        if (mode === 'color') {
          coloreSpan.textContent = d.COLORE;
        } else {
          coloreSpan.textContent = 'Tutte le colorazioni';
        }

        left.appendChild(catSpan);
        left.appendChild(tipoSpan);
        left.appendChild(coloreSpan);

        const tagliaBadge = document.createElement('div');
        tagliaBadge.className = 'badge-taglia';
        tagliaBadge.textContent = 'Taglia ' + d.Taglia;

        header.appendChild(left);
        header.appendChild(tagliaBadge);

        const rowVenduti = document.createElement('div');
        rowVenduti.className = 'row';
        rowVenduti.innerHTML = '<div class="row-label">Venduti storici</div>' +
                               '<div class="row-values">' + d.venduti + '</div>';

        const rowRistampa = document.createElement('div');
        rowRistampa.className = 'row';
        rowRistampa.innerHTML = '<div class="row-label">Suggeriti per ristampa</div>' +
                                '<div class="row-values"><strong>' + d.ristampa + '</strong></div>';

        card.appendChild(header);
        card.appendChild(rowVenduti);
        card.appendChild(rowRistampa);

        cardsEl.appendChild(card);
      }
    }

    function renderRecap(allocations) {
      const mode = modeSelect.value;
      const topSetting = topNSelect.value;

      const keyMap = new Map();
      for (const d of allocations) {
        const coloreKey = mode === 'color' ? d.COLORE : 'Tutte le colorazioni';
        const key = d.Categoria + '||' + d.TIPO + '||' + coloreKey;
        if (!keyMap.has(key)) {
          keyMap.set(key, {
            Categoria: d.Categoria,
            TIPO: d.TIPO,
            COLORE: coloreKey,
            venduti: 0,
            ristampa: 0
          });
        }
        const obj = keyMap.get(key);
        obj.venduti += d.venduti;
        obj.ristampa += d.ristampa;
      }

      let rows = Array.from(keyMap.values());
      rows.sort((a, b) => b.venduti - a.venduti);

      if (topSetting !== 'ALL') {
        const n = parseInt(topSetting, 10);
        rows = rows.slice(0, n);
      }

      recapBody.innerHTML = '';

      if (rows.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.textContent = 'Nessun elemento con i filtri selezionati.';
        tr.appendChild(td);
        recapBody.appendChild(tr);
        return;
      }

      for (const r of rows) {
        const tr = document.createElement('tr');
        const tdCat = document.createElement('td');
        tdCat.textContent = r.Categoria;
        const tdTipo = document.createElement('td');
        tdTipo.textContent = r.TIPO;
        const tdCol = document.createElement('td');
        tdCol.textContent = r.COLORE;
        const tdVend = document.createElement('td');
        tdVend.textContent = r.venduti;
        const tdRis = document.createElement('td');
        tdRis.textContent = r.ristampa;

        tr.appendChild(tdCat);
        tr.appendChild(tdTipo);
        tr.appendChild(tdCol);
        tr.appendChild(tdVend);
        tr.appendChild(tdRis);
        recapBody.appendChild(tr);
      }
    }

    function renderChart() {
      const { allocations } = computeAllocations();
      const mode = modeSelect.value;
      const topSetting = topNSelect.value;

      const keyMap = new Map();
      for (const d of allocations) {
        const coloreKey = mode === 'color' ? d.COLORE : 'Tutte le colorazioni';
        const key = d.TIPO + '||' + coloreKey;
        if (!keyMap.has(key)) {
          keyMap.set(key, {
            label: mode === 'color' ? (d.TIPO + ' (' + coloreKey + ')') : d.TIPO,
            venduti: 0
          });
        }
        const obj = keyMap.get(key);
        obj.venduti += d.venduti;
      }

      let rows = Array.from(keyMap.values());
      rows.sort((a, b) => b.venduti - a.venduti);

      if (topSetting !== 'ALL') {
        const n = parseInt(topSetting, 10);
        rows = rows.slice(0, n);
      }

      const labels = rows.map(r => r.label);
      const values = rows.map(r => r.venduti);

      const trace = {
        type: 'bar',
        x: values,
        y: labels,
        orientation: 'h'
      };
      const layout = {
        margin: {l: 220, r: 10, t: 10, b: 30},
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {color: '#f7f7f7'},
        xaxis: {title: 'Capi venduti'},
        yaxis: {automargin: true}
      };
      Plotly.newPlot('chart', [trace], layout, {displayModeBar: false, responsive: true});
    }

    function renderAll() {
      refreshTipoOptions();
      const { allocations, totalTarget } = getAllocationsFiltered();
      updateTargetTotal(totalTarget);
      renderCards(allocations);
      renderRecap(allocations);
      renderChart();
    }

    function updateTargetTotal(totalTarget) {
      totTargetSpan.textContent = totalTarget;
    }

    function attachEvents() {
      categoriaFilter.addEventListener('change', renderAll);
      tipoFilter.addEventListener('change', renderAll);
      tagliaFilter.addEventListener('change', renderAll);
      modeSelect.addEventListener('change', renderAll);
      scenarioSelect.addEventListener('change', renderAll);
      topNSelect.addEventListener('change', renderAll);

      btnCards.addEventListener('click', () => {
        btnCards.classList.add('active');
        btnRecap.classList.remove('active');
        cardsView.style.display = 'block';
        recapView.style.display = 'none';
      });
      btnRecap.addEventListener('click', () => {
        btnRecap.classList.add('active');
        btnCards.classList.remove('active');
        cardsView.style.display = 'none';
        recapView.style.display = 'block';
      });
    }

    loadData().catch(err => {
      console.error('Errore nel caricamento dei dati:', err);
      cardsEl.innerHTML = '<p class="desc">Errore nel caricamento di data-merch.csv</p>';
    });
  </script>
</body>
</html>
